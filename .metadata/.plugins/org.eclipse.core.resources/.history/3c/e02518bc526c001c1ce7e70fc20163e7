<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt"%>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" type="text/css" href="/resources/css/style.css">
<title>QnA</title>
</head>
<style>
a {
	text-decoration: none; /* 링크의 밑줄 제거 */
	color: inherit; /* 링크의 색상 제거 */
}
</style>

<body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script type="text/javascript">
</script>
	<%
    String checkLogin = (String) session.getAttribute("checkLogin");
    Character checkAdmin = (Character) session.getAttribute("checkAdmin");
    Character checkMember = (Character) session.getAttribute("checkMember");
%>
	<!-- $header -->
	<header class="main_header">
		<div class="header_title_conteiner">
			<div class="header_title_title">
				<div class="header_title">
					<a href="/main">TEA PARTY</a>
				</div>
			</div>
			<div class="header_controller_conteiner">
				<%
                if (checkLogin == "success" && checkMember == 'N') {
            %>
				<div class="header_controller">
					<a href="/mypage">MY PAGE</a>
				</div>
				<div class="header_controller">
					<a href="/cart.pay">MY SHOPPING</a>
				</div>
				<div class="header_controller">
					<a href="/logout">LOGOUT</a>
				</div>
				<%
                if (checkAdmin != 'N') {
            %>
				<div class="header_controller">
					<a href="/admin.ad">ADMIN</a>
				</div>
				<%
                }
            %>
				<%
            }
            %>

			</div>
		</div>
		</div>
	</header>
	<% 
	String mem_id = (String) session.getAttribute("mem_id");
	if (checkLogin == "success") { %>
	
	
	<form action="boardUpdate.board" method="post" name="frm">
		글번호 ${board.board_no}<br>
		글제목<input type="text" name="board_sub" value="${board.board_sub}"><br>
		작성 일자 <fmt:formatDate value="${board.board_date}"/><br>
		작성자 ${board.mem_id}<br>
		글 내용<br>
		<textarea rows="5" cols="50" style="resize: none;" name="board_content">${board.board_content}</textarea>
		<br> <input type="hidden" name="board_no" value="${board.board_no}" id="board_no">
		<input type="button" value="수정" onclick="checkSubmit()"><br>
		<input type="button" value="QnA 리스트" onclick="location.href='qnaList.board'">
		<input type="hidden" value="${mem_id}" id="mem_id" name="mem">
	</form>
	<form action="qnaDelete.board" method="post" name="deletefrm">
		<input type="hidden" value="${board.board_no}" name="board_no">
		<input type="button" onclick="deleteSubmit()" value="삭제">
	</form>
	<br>
	<h3>댓글</h3>
	<!-- Comments Form -->
	<form name="comment-form" action="insertComment.board" method="post"
		autocomplete="off">
		<input type="hidden" name="board_no" value="${board.board_no}">
		<textarea style="width: 1100px" rows="3" cols="30" name="reply_content" placeholder="댓글을 입력하세요" style="resize: none;"></textarea>
		<button type="submit">Submit</button>
	</form>
	
	<div class="replyTable" id="rtb">
		<div></div>
	</div>

	<%
		} else {
%>
	<script type="text/javascript">
	alert("로그인 하셔야 합니다!");
	location.href="/login";
	</script>
	<%
		}
	%>


	<script type="text/javascript">
	function checkSubmit() {
        var board_sub = document.getElementsByName('board_sub')[0].value;
        var board_content = document.getElementsByName('board_content')[0].value;
        if(!board_sub){
        	alert("제목을 입력하세요");
        	board_sub.focus();
        	return false;
        }
        if(!board_content){
        	alert("내용을 입력하세요");
        	board_content.focus();
        	return false;
        }
        frm.method = 'post';
        frm.submit();
      }
	function deleteSubmit() {
		 if (confirm("정말 삭제하시겠습니까??") == true){
		     document.deletefrm.submit();
		 }else{
		     return false;
		 }
      }
	
	$(document).ready(function(){
		   getCommentList();
		  
		});
		 
		/**
		 * 댓글 불러오기(Ajax)
		 */

		function getCommentList() {
			var board_no = $('#board_no').val();
			 
			$.ajax({
				type : 'GET',
				url : "/commentList.board",
				data : {board_no : board_no},
				dataType: "json", // 전송타입 json으로 변경
				success : function(data) {
					var $tableBody = $('#rtb div');
					$tableBody.html('');
					if(data.length > 0){
						var mem_id= $('#mem_id').val();
						for(var i in data){
							var $tr = $('<div class="rtb_reply">');
							var $delBtn  = $('<button id="deleteReply" onclick="deleteReply(' + data[i].reply_no+ ')">삭제</button>');
							var $rWriter = $('<div>').text(data[i].reply_sub);
							var $rContent = $('<div>').text(data[i].reply_content);
							var $rCreateDate = $('<div width=150>').text(data[i].reply_date);
							$tr.append($rWriter);
							$tr.append($rContent);
							$tr.append($rCreateDate);
							if(mem_id==data[i].reply_sub){
								$tr.append($delBtn);
							}
							$tableBody.append($tr);
						}
					}else{
						var $tr = $('<div>');
						var $rContent = $('<div>').text('등록된 댓글이 없습니다');
						$tr.append($rContent);
						$tableBody.append($tr);
					}
				},
				error : function(result) {
				},
				complete : function() {

				}

			});
		}
		
		function deleteReply(reply_no) {
			$.ajax({
				type : 'POST',
				url : "/deleteReply.board",
				data : {reply_no : reply_no},
				dataType: "json", // 전송타입 json으로 변경
				success : function(data) {
					if(data.resultCode=='1'){
						alert('댓글 삭제에 '+data.resultMSG);
					}else {
						alert('댓글 삭제에 '+data.resultMSG);
					}
				},
				error : function(result) {
					console.log('오류는 왜 존재하는 걸까');
				},
				complete : function() {
					getCommentList();
				}

			});
	      }
	</script>
</body>
</html>